<!--
  Copyright (C) 2026 Redcar & Cleveland Borough Council
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

{% extends 'base.html' %}

{% block title %}Members Enquiries - Dashboard{% endblock %}

{% block content %}
<!-- CSRF token for AJAX requests -->
{% csrf_token %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active" aria-current="page">Home</li>
        </ol>
    </nav>
    <h1>Members' Enquiries Dashboard</h1>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Enquiry Overview</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="p-3 border rounded bg-info text-light">
                            <h3>{{ enquiry_counts.total }}</h3>
                            <p class="mb-0">Total Enquiries</p>
                            <a href="{% url 'application:enquiry_list' %}?date_range=all" class="btn btn-sm btn-light mt-2">View All</a>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="p-3 border rounded bg-primary text-light">
                            <h3>{{ enquiry_counts.open }}</h3>
                            <p class="mb-0">Open</p>
                            <a href="{% url 'application:enquiry_list' %}?status=open" class="btn btn-sm btn-light mt-2">View</a>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="p-3 border rounded bg-danger text-light">
                            <h3>{{ overdue_count }}</h3>
                            <p class="mb-0">Overdue (>5 days)</p>
                            <a href="{% url 'application:enquiry_list' %}?status=open&overdue_only=true" class="btn btn-sm btn-light mt-2">View</a>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="p-3 border rounded bg-success text-light">
                            <h3>{{ enquiry_counts.closed }}</h3>
                            <p class="mb-0">Closed</p>
                            <a href="{% url 'application:enquiry_list' %}?status=closed&date_range=all" class="btn btn-sm btn-light mt-2">View</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Recent Enquiries</h5>
            </div>
            <div class="card-body">
                {% if recent_enquiries %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Title</th>
                                <th>Member</th>
                                <th>Status</th>
                                <th>Section</th>
                                <th>Added By</th>
                                <th>Created</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for enquiry in recent_enquiries %}
                            <tr data-enquiry-id="{{ enquiry.id }}" {% if enquiry.due_date < today and enquiry.status != 'closed' %}class="table-warning"{% endif %}>
                                <td>
                                    <a href="{% url 'application:enquiry_detail' enquiry.id %}" class="text-decoration-none fw-bold">
                                        {{ enquiry.reference|default:"No Ref" }}
                                    </a>
                                </td>
                                <td>{{ enquiry.title|truncatechars:40 }}</td>
                                <td>{{ enquiry.member.full_name }}</td>
                                <td>
                                    <span class="badge {% if enquiry.status == 'new' or enquiry.status == 'open' %}bg-primary{% elif enquiry.status == 'closed' %}bg-success{% else %}bg-secondary{% endif %}">
                                        {% if enquiry.status == 'new' %}Open{% else %}{{ enquiry.get_status_display }}{% endif %}
                                    </span>
                                </td>
                                <td>{{ enquiry.section.name|default:"Not assigned" }}</td>
                                <td>
                                    {% if enquiry.admin and enquiry.admin.user %}
                                        {{ enquiry.admin.user.get_full_name|default:enquiry.admin.user.username }}
                                    {% else %}
                                        Unassigned
                                    {% endif %}
                                </td>
                                <td>{{ enquiry.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <span class="{% if enquiry.due_date < today and enquiry.status != 'closed' %}text-danger fw-bold{% endif %}">
                                        {{ enquiry.due_date|date:"M d, Y" }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'application:enquiry_detail' enquiry.id %}" class="btn btn-outline-primary" title="View enquiry details">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                        {% if enquiry.status != 'closed' %}
                                            <a href="{% url 'application:enquiry_edit' enquiry.id %}" class="btn btn-outline-secondary" title="Edit this enquiry">
                                                <i class="bi bi-pencil"></i> Edit
                                            </a>
                                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#closeEnquiryModal{{ enquiry.id }}" title="Close this enquiry">
                                                <i class="bi bi-x-circle"></i> Close
                                            </button>
                                        {% else %}
                                            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#reopenEnquiryModal{{ enquiry.id }}" title="Re-open this enquiry">
                                                <i class="bi bi-arrow-clockwise"></i> Re-open
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center my-4">No enquiries yet. </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Include action modals for each enquiry -->
{% for enquiry in recent_enquiries %}
    {% include 'partials/enquiry_action_modals.html' %}
{% endfor %}
{% endblock %}