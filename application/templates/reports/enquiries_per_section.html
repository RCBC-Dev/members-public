<!--
  Copyright (C) 2026 Redcar & Cleveland Borough Council
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

{% extends "base.html" %}
{% block title %}Enquiries per Section - Members Enquiries{% endblock %}

{% block container_class %}container-fluid{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'application:index' %}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Enquiries per Section</li>
            </ol>
        </nav>
        <h1>üè¢ Enquiries per Section</h1>
        <p class="text-muted">Showing enquiry counts for the last 12 months (from {{ date_from|date:"d/m/Y" }})</p>
    </div>
</div>

<!-- Service Type Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3" id="filterForm">
            <div class="col-md-4">
                <label for="service_type" class="form-label">Filter by Service Type</label>
                <select name="service_type" id="service_type" class="form-select">
                    <option value="">All Service Types</option>
                    <option value="failed_service" {% if service_type == 'failed_service' %}selected{% endif %}>Failed service</option>
                    <option value="new_addition" {% if service_type == 'new_addition' %}selected{% endif %}>New/addition requests</option>
                    <option value="pre_programmed" {% if service_type == 'pre_programmed' %}selected{% endif %}>Pre-programmed work</option>
                    <option value="3rd_party" {% if service_type == '3rd_party' %}selected{% endif %}>3rd Party</option>
                </select>
            </div>
        </form>
        <script type="text/javascript" nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
  // Auto-submit form when any filter changes
  const filterForm = document.getElementById('filterForm');
  if (filterForm) {
    const filterInputs = filterForm.querySelectorAll('select, input[type="date"]');
    filterInputs.forEach(input => {
      input.addEventListener('change', function() {
        filterForm.submit();
      });
    });
  }
});
</script>
    </div>
</div>

<!-- Summary Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Total Sections</h5>
                <h2>{{ sections.count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Total Enquiries</h5>
                <h2>{{ total_enquiries }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Average per Section</h5>
                <h2>{{ average_per_section|floatformat:1 }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Enquiries per Section Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Section Enquiry Counts</h5>
    </div>
    <div class="card-body">
        {% if sections %}
        <div>
            <table class="table table-striped table-hover" id="sectionEnquiriesTable">
                <thead>
                    <tr>
                        <th>Section</th>
                        <th>Department</th>
                        <th>Enquiry Count</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for section in sections %}
                    <tr>
                        <td>{{ section.name }}</td>
                        <td>{{ section.department.name|default:"No Department" }}</td>
                        <td>
                            <a href="{% url 'application:enquiry_list' %}?section={{ section.id }}&date_from={{ date_from|date:'Y-m-d' }}{% if service_type %}&service_type={{ service_type }}{% endif %}"
                               class="btn btn-sm btn-outline-primary">
                                {{ section.enquiry_count }}
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'application:enquiry_list' %}?section={{ section.id }}&date_from={{ date_from|date:'Y-m-d' }}{% if service_type %}&service_type={{ service_type }}{% endif %}"
                               class="btn btn-sm btn-outline-secondary">View Enquiries</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <h5 class="text-muted">No Data Available</h5>
            <p class="text-muted">No enquiries found for the selected time period.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
$(document).ready(function() {
    $('#sectionEnquiriesTable').DataTable({
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
        "order": [[ 2, "desc" ]], // Sort by Enquiry Count descending
        "columnDefs": [
            { "orderable": false, "targets": 3 }, // Disable sorting on Actions column
            { "targets": 2, "className": "text-center" } // Center align count column
        ],
        "dom": '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-3"f><"col-sm-12 col-md-3"l>>' +
               '<"row"<"col-sm-12"tr>>' +
               '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        "buttons": [
            {
                extend: 'copy',
                text: '<i class="bi bi-clipboard"></i> Copy',
                className: 'btn btn-primary btn-sm',
                exportOptions: {
                    columns: [0, 1, 2], // Exclude Actions column
                    format: {
                        body: formatDataTableExport
                    }
                }
            },
            {
                extend: 'csv',
                text: '<i class="bi bi-file-earmark-text"></i> CSV',
                className: 'btn btn-success btn-sm',
                title: 'Enquiries_Per_Section_' + new Date().toISOString().slice(0,10),
                exportOptions: {
                    columns: [0, 1, 2], // Exclude Actions column
                    format: {
                        body: formatDataTableExport
                    }
                }
            },
            {
                extend: 'excel',
                text: '<i class="bi bi-file-earmark-excel"></i> Excel',
                className: 'btn btn-success btn-sm',
                title: 'Enquiries_Per_Section_' + new Date().toISOString().slice(0,10),
                exportOptions: {
                    columns: [0, 1, 2], // Exclude Actions column
                    format: {
                        body: formatDataTableExport
                    }
                }
            },
            {
                extend: 'pdf',
                text: '<i class="bi bi-file-earmark-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm',
                title: 'Enquiries Per Section Report',
                orientation: 'landscape',
                pageSize: 'A4',
                exportOptions: {
                    columns: [0, 1, 2], // Exclude Actions column
                    format: {
                        body: formatDataTableExport
                    }
                }
            }
        ],
        "stateSave": true,
        "language": {
            "search": "Filter results:",
            "lengthMenu": "Show _MENU_ enquiries per page"
        }
    });
});
</script>
{% endblock %}