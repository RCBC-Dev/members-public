<!--
  Copyright (C) 2026 Redcar & Cleveland Borough Council
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load url_filters %}

{% block title %}Enquiries - Members' Enquiries System{% endblock %}

{% block container_class %}container-fluid{% endblock %}

{% block content %}
<!-- CSRF token for AJAX requests -->
{% csrf_token %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'application:index' %}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Enquiries</li>
            </ol>
        </nav>
        <h1>{{ dynamic_title|default:"Members Enquiries" }}</h1>
    </div>
    <a href="{% url 'application:enquiry_create' %}" class="btn btn-primary">Create New Enquiry</a>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Filter Enquiries</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3" id="filterForm">
            <!-- Row 1: Search, Date Range, Date Filters, Admin -->
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="{{ filter_form.search.id_for_label }}" class="form-label">{{ filter_form.search.label }}</label>
                    {{ filter_form.search }}
                </div>
                <div class="col-md-2">
                    <label for="{{ filter_form.date_range.id_for_label }}" class="form-label">{{ filter_form.date_range.label }}</label>
                    {{ filter_form.date_range }}
                </div>
                <div class="col-md-2">
                    <label for="{{ filter_form.date_from.id_for_label }}" class="form-label">{{ filter_form.date_from.label }}</label>
                    {{ filter_form.date_from }}
                </div>
                <div class="col-md-2">
                    <label for="{{ filter_form.date_to.id_for_label }}" class="form-label">{{ filter_form.date_to.label }}</label>
                    {{ filter_form.date_to }}
                </div>
                <div class="col-md-1">
                    <label for="{{ filter_form.admin.id_for_label }}" class="form-label">{{ filter_form.admin.label }}</label>
                    {{ filter_form.admin }}
                </div>
                <div class="col-md-1">
                    <div class="form-check mt-4">
                        {{ filter_form.overdue_only }}
                        <label class="form-check-label" for="{{ filter_form.overdue_only.id_for_label }}">
                            {{ filter_form.overdue_only.label }}
                        </label>
                    </div>
                </div>
                <div class="col-md-1">
                    <a href="{% url 'application:enquiry_list' %}" class="btn btn-danger btn-sm mt-4">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </a>
                </div>
            </div>

            <!-- Row 2: Status, Member, Ward, Section, Job Type, Service Type, Contact -->
            <div class="row g-3 mt-1">
                <div class="col-md-1">
                    <label for="{{ filter_form.status.id_for_label }}" class="form-label">{{ filter_form.status.label }}</label>
                    {{ filter_form.status }}
                </div>
                <div class="col-md-2">
                    <label for="{{ filter_form.member.id_for_label }}" class="form-label">{{ filter_form.member.label }}</label>
                    {{ filter_form.member }}
                </div>
                <div class="col-md-2">
                    <label for="{{ filter_form.ward.id_for_label }}" class="form-label">{{ filter_form.ward.label }}</label>
                    {{ filter_form.ward }}
                </div>
                <div class="col-md-2">
                    <label for="{{ filter_form.section.id_for_label }}" class="form-label">{{ filter_form.section.label }}</label>
                    {{ filter_form.section }}
                </div>
                <div class="col-md-2">
                    <label for="{{ filter_form.job_type.id_for_label }}" class="form-label">{{ filter_form.job_type.label }}</label>
                    {{ filter_form.job_type }}
                </div>
                <div class="col-md-2">
                    <label for="{{ filter_form.service_type.id_for_label }}" class="form-label">{{ filter_form.service_type.label }}</label>
                    {{ filter_form.service_type }}
                </div>
                <div class="col-md-1">
                    <label for="{{ filter_form.contact.id_for_label }}" class="form-label">{{ filter_form.contact.label }}</label>
                    {{ filter_form.contact }}
                </div>
            </div>
        </form>



    </div>
</div>

<!-- Enquiries List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0" id="enquiriesCardTitle">Enquiries</h5>
    </div>
    <div class="card-body">
        <!-- Loading indicator -->
        <div id="tableLoading" class="table-loading-container">
            <div class="spinner-border text-primary table-loading-spinner" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5>Loading enquiries...</h5>
                <p class="text-muted">Please wait while we prepare your data</p>
            </div>
        </div>

        <!-- Table (initially hidden) -->
        <div id="tableContainer" class="table-container-hidden">
            <table class="table table-striped table-hover w-100" id="enquiriesTable">
                <thead>
                    <tr>
                        <th>Reference</th>
                        <th>Title</th>
                        <th>Member</th>
                        <th>Section</th>
                        <th>Job Type</th>
                        <th>Service Type</th>
                        <th>Contact</th>
                        <th>Status</th>
                        <th>Admin</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <th>Due Date</th>
                        <th>Overdue Days</th>
                        <th>Closed</th>
                        <th>Resolution Days</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded via AJAX -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Single reusable modal for enquiry actions -->
<div class="modal fade" id="enquiryActionModal" tabindex="-1" aria-labelledby="enquiryActionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="enquiryActionModalLabel">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i><span id="modalActionTitle">Action</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="modalActionMessage">Are you sure?</p>
        <div class="alert alert-info">
          <strong id="modalEnquiryRef">Enquiry</strong> - <span id="modalEnquiryTitle">Title</span>
        </div>
        <p class="text-muted mb-0" id="modalActionDetails">Additional details...</p>

        <!-- Re-open specific fields (hidden by default) -->
        <div id="reopenFields" class="d-none">
          <div class="mb-3">
            <label for="reopenReason" class="form-label">Reason for re-opening:</label>
            <select class="form-select" id="reopenReason" required>
              <option value="">Select a reason...</option>
              <option value="Closed in Error">Closed in Error</option>
              <option value="Enquiry not completed">Enquiry not completed</option>
              <option value="Enquiry re-occurred">Enquiry re-occurred</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="reopenNote" class="form-label">Additional notes (optional):</label>
            <textarea class="form-control" id="reopenNote" rows="3" placeholder="Add any additional details..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmActionBtn">
          <i class="bi bi-x-circle me-1"></i><span id="confirmActionText">Confirm</span>
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
$(document).ready(function() {
    // Hide loading overlay when page loads
    hideLoadingOverlay();

    // Get current filter values from the form elements instead of URL
    function getCurrentFilters() {
        var filters = {};
        $('#filterForm').find('input, select').each(function() {
            var $elem = $(this);
            var name = $elem.attr('name');
            var value = $elem.val();

            // Special handling for checkboxes
            if ($elem.attr('type') === 'checkbox') {
                if ($elem.is(':checked')) {
                    filters[name] = 'on';
                }
                // Don't include unchecked checkboxes
            } else if (name && value) {
                filters[name] = value;
            }
        });
        return filters;
    }

    // Initialize with current form state
    var currentFilters = getCurrentFilters();

    // Initialize current dynamic title from page load
    window.currentDynamicTitle = '{{ dynamic_title|default:"Members Enquiries"|escapejs }}';

    // Toast notification function is now global in base.html

    var table = $('#enquiriesTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{% url 'application:enquiry_list_datatables' %}",
            "type": "POST",
            "data": function(d) {
                // Add filter parameters to DataTables request
                $.extend(d, currentFilters);
                // Add CSRF token for POST requests
                d.csrfmiddlewaretoken = $('[name=csrfmiddlewaretoken]').val();
                return d;
            },
            "error": function(xhr, error, code) {
                console.error('DataTables AJAX Error:', error, code);
                console.error('Response:', xhr.responseText);
                // Show user-friendly error message
                $('#tableLoading').html(
                    '<div class="alert alert-danger">' +
                    '<h5>Error Loading Data</h5>' +
                    '<p>Unable to load enquiries. Please refresh the page or contact support.</p>' +
                    '<small>Error: ' + error + '</small>' +
                    '</div>'
                );
            }
        },
        "pageLength": 10,  // Back to original default
        "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
        "order": [[ 8, "desc" ]], // Sort by Created date descending
        "columnDefs": [
            { "orderable": false, "targets": [11, 13, 14] }, // Disable sorting on Overdue Days, Resolution Time, and Actions columns
            { "searchable": false, "targets": [11, 13, 14] },  // Disable search on calculated and action columns
            { "visible": true, "targets": [9] }, // Show Updated column by default
            { "visible": true, "targets": [11] } // Show Overdue Days column by default
        ],
        "dom": 'B<"row"<"col-sm-8"f><"col-sm-4 text-end"l>>rtip',
        "stateSave": true,      // Re-enable state saving
        "stateDuration": -1,    // Save state forever
        "stateSaveCallback": function(settings, data) {
            // Custom state saving for server-side processing
            localStorage.setItem('DataTables_enquiries_state', JSON.stringify(data));
        },
        "stateLoadCallback": function(settings) {
            // Custom state loading for server-side processing
            var saved = localStorage.getItem('DataTables_enquiries_state');
            return saved ? JSON.parse(saved) : null;
        },
        "buttons": [
            {
                text: '<i class="bi bi-clipboard"></i> Copy (Page)',
                className: 'btn btn-secondary btn-sm',
                action: function(e, dt, node, config) {
                    // Copy current page only
                    var data = dt.rows({page: 'current'}).data();
                    var textData = '';
                    data.each(function(row) {
                        // Remove HTML tags and join with tabs
                        var cleanRow = row.slice(0, -1).map(function(cell) {
                            return $('<div>').html(cell).text();
                        }).join('\t');
                        textData += cleanRow + '\n';
                    });
                    navigator.clipboard.writeText(textData);
                    showToast('Current page copied to clipboard!', 'success');
                }
            },
            {
                text: '<i class="bi bi-file-earmark-text"></i> CSV (All)',
                className: 'btn btn-success btn-sm',
                action: function(e, dt, node, config) {
                    exportAllData('csv');
                }
            },
            {
                text: '<i class="bi bi-file-earmark-excel"></i> Excel (All)',
                className: 'btn btn-success btn-sm',
                action: function(e, dt, node, config) {
                    exportAllData('excel');
                }
            },
            {
                text: '<i class="bi bi-file-earmark-pdf"></i> PDF (Page)',
                className: 'btn btn-danger btn-sm',
                extend: 'pdf',
                title: function() {
                    return window.currentDynamicTitle || 'Enquiries Export';
                },
                orientation: 'landscape',
                pageSize: 'A4',
                exportOptions: {
                    columns: ':visible:not(:last-child)',
                    format: {
                        body: function(data, row, column, node) {
                            return $('<div>').html(data).text();
                        }
                    }
                }
            },
            {
                text: '<i class="bi bi-printer"></i> Print (Page)',
                className: 'btn btn-primary btn-sm',
                extend: 'print',
                title: '{{ dynamic_title|default:"Enquiries List"|escapejs }}',
                exportOptions: {
                    columns: ':visible:not(:last-child)',
                    format: {
                        body: function(data, row, column, node) {
                            return $('<div>').html(data).text();
                        }
                    }
                }
            },
            {
                extend: 'colvis',
                text: '<i class="bi bi-eye"></i> Columns',
                className: 'btn btn-info btn-sm'
            }
        ],
        "language": {
            "search": "Search all enquiries:",
            "searchPlaceholder": "Search reference, title, or description...",
            "lengthMenu": "Show _MENU_ enquiries per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ enquiries",
            "infoEmpty": "No enquiries available",
            "infoFiltered": "(filtered from _MAX_ total enquiries)",
            "emptyTable": "No enquiries found matching your criteria",
            "zeroRecords": "No matching enquiries found",
            "processing": "Searching enquiries...",
            "paginate": {
                "first": "First",
                "last": "Last",
                "next": "Next",
                "previous": "Previous"
            }
        },
        "responsive": false,
        "initComplete": function(settings, json) {
            // Hide loading overlay and loading indicator
            hideLoadingOverlay();
            $('#tableLoading').hide();
            $('#tableContainer').removeClass('table-container-hidden').fadeIn(300);

            // Update card header with filtered count
            updateCardHeader(json);
        },
        "drawCallback": function(settings) {
            // Hide loading overlay (for filter changes)
            hideLoadingOverlay();

            // Update card header with current filtered count
            var api = this.api();
            var json = api.ajax.json();
            updateCardHeader(json);

            // AJAX close functionality handled by custom.js
        }
    });

    // Function to update card header with filtered count and dynamic title
    function updateCardHeader(json) {
        if (json && typeof json.recordsFiltered !== 'undefined') {
            var filteredCount = json.recordsFiltered;
            var totalCount = json.recordsTotal;

            var headerText = 'Enquiries';
            if (filteredCount !== totalCount) {
                // Show filtered count when filters are applied
                headerText = `Enquiries (${filteredCount.toLocaleString()})`;
            } else {
                // Show total count when no filters applied
                headerText = `Enquiries (${totalCount.toLocaleString()})`;
            }

            $('#enquiriesCardTitle').text(headerText);
        }

        // Update dynamic title if provided in response
        if (json && json.dynamicTitle) {
            $('h1').first().text(json.dynamicTitle);

            // Store current dynamic title for exports (PDF title function will use this)
            window.currentDynamicTitle = json.dynamicTitle;
        }
    }

    // Function to export all filtered data
    function exportAllData(format) {
        // Show loading indicator
        var loadingHtml = '<i class="spinner-border spinner-border-sm me-2"></i>Preparing export...';
        var buttonText = format === 'csv' ? 'CSV (All)' : 'Excel (All)';
        var $button = $('[data-format="' + format + '"]');
        if ($button.length === 0) {
            $button = $('.btn:contains("' + buttonText + '")');
        }

        if ($button.length > 0) {
            var originalHtml = $button.html();
            $button.html(loadingHtml).prop('disabled', true);

            // Restore button after delay
            setTimeout(function() {
                $button.html(originalHtml).prop('disabled', false);
            }, 3000);
        }

        // Get current filters including DataTables search
        var exportFilters = getCurrentFilters();
        var tableSearch = table.search();
        if (tableSearch) {
            exportFilters['search[value]'] = tableSearch;
        }

        // Build export URL
        var baseUrl = format === 'csv' ? '{% url "application:export_enquiries_csv" %}' : '{% url "application:export_enquiries_excel" %}';
        var exportUrl = baseUrl + '?' + $.param(exportFilters);

        // Trigger download
        window.location.href = exportUrl;

        // Show success toast with current dynamic title
        var formatName = format.toUpperCase();
        var titleText = window.currentDynamicTitle || 'Enquiries';
        showToast(`${formatName} export of "${titleText}" started! Your download should begin shortly.`, 'success');
    }

    // Handle single modal for enquiry actions
    $('#enquiryActionModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var enquiryId = button.data('enquiry-id');
        var enquiryRef = button.data('enquiry-ref');
        var enquiryTitle = button.data('enquiry-title');
        var action = button.data('action');

        var modal = $(this);

        // Store enquiry ID for later use
        modal.data('enquiry-id', enquiryId);
        modal.data('action', action);

        // Update modal content based on action
        if (action === 'close') {
            modal.find('#modalActionTitle').text('Close Enquiry');
            modal.find('#modalActionMessage').text('Are you sure you want to close this enquiry?');
            modal.find('#modalActionDetails').text('This will mark the enquiry as resolved. You can still view the enquiry details, but it will be considered complete.');
            modal.find('#confirmActionBtn').removeClass('btn-success').addClass('btn-danger');
            modal.find('#confirmActionBtn i').removeClass('bi-arrow-clockwise').addClass('bi-x-circle');
            modal.find('#confirmActionText').text('Close Enquiry');
            modal.find('#reopenFields').addClass('d-none');
        } else if (action === 'reopen') {
            modal.find('#modalActionTitle').text('Re-Open Enquiry');
            modal.find('#modalActionMessage').text('Please select a reason for re-opening this enquiry:');
            modal.find('#modalActionDetails').text('');
            modal.find('#confirmActionBtn').removeClass('btn-danger').addClass('btn-success');
            modal.find('#confirmActionBtn i').removeClass('bi-x-circle').addClass('bi-arrow-clockwise');
            modal.find('#confirmActionText').text('Re-Open Enquiry');
            modal.find('#reopenFields').removeClass('d-none');

            // Reset reopen form
            modal.find('#reopenReason').val('');
            modal.find('#reopenNote').val('');
            modal.find('#confirmActionBtn').prop('disabled', true);
        }

        // Update enquiry info
        modal.find('#modalEnquiryRef').text(enquiryRef);
        modal.find('#modalEnquiryTitle').text(enquiryTitle);
    });

    // Enable/disable reopen button based on reason selection
    $('#reopenReason').on('change', function() {
        var hasReason = $(this).val() !== '';
        $('#confirmActionBtn').prop('disabled', !hasReason);
    });

    // Handle confirm action button
    $('#confirmActionBtn').on('click', function() {
        var modal = $('#enquiryActionModal');
        var enquiryId = modal.data('enquiry-id');
        var action = modal.data('action');

        if (action === 'close') {
            // Close enquiry via AJAX
            closeEnquiryAjax(enquiryId);
        } else if (action === 'reopen') {
            // Reopen enquiry via AJAX
            var reason = $('#reopenReason').val();
            var note = $('#reopenNote').val();
            reopenEnquiryAjax(enquiryId, reason, note);
        }

        modal.modal('hide');
    });

    // AJAX close function
    function closeEnquiryAjax(enquiryId) {
        $.ajax({
            url: "{% url 'application:enquiry_close' 0 %}".replace('0', enquiryId),
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    showToast('Enquiry closed successfully!', 'success');
                    table.ajax.reload(null, false); // Reload table data
                } else {
                    showToast('Error: ' + (response.message || 'Failed to close enquiry'), 'error');
                }
            },
            error: function() {
                showToast('Error: Failed to close enquiry', 'error');
            }
        });
    }

    // AJAX reopen function
    function reopenEnquiryAjax(enquiryId, reason, note) {
        $.ajax({
            url: "{% url 'application:enquiry_reopen' 0 %}".replace('0', enquiryId),
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
                'reason': reason,
                'note': note
            },
            success: function(response) {
                if (response.success) {
                    showToast('Enquiry re-opened successfully!', 'success');
                    table.ajax.reload(null, false); // Reload table data
                } else {
                    showToast('Error: ' + (response.message || 'Failed to re-open enquiry'), 'error');
                }
            },
            error: function() {
                showToast('Error: Failed to re-open enquiry', 'error');
            }
        });
    }

    // Fix table width when column visibility changes
    table.on('column-visibility.dt', function(e, settings, column, state) {
        setTimeout(function() {
            table.columns.adjust();
        }, 10);
    });

    // Adjust table when window is resized
    $(window).on('resize', function() {
        table.columns.adjust();
    });

    // Filter form handling
    function updateFiltersAndReload() {
        // Show loading overlay - DISABLED FOR DEMO (too fast on TEST system)
        // showLoadingForQuery("Fetching Data", "Please wait while we load the enquiries");

        // Update currentFilters from form
        currentFilters = getCurrentFilters();

        // Reload DataTable with new filters - this will trigger drawCallback which updates the title
        table.ajax.reload();

        // Update URL without page reload
        var newUrl = window.location.pathname;
        var params = $.param(currentFilters);
        if (params) {
            newUrl += '?' + params;
        }
        history.replaceState({filters: currentFilters}, '', newUrl);
    }

    // Auto-submit form when filters change
    $('#filterForm select, #filterForm input[type="checkbox"]').on('change', function() {
        updateFiltersAndReload();
    });

    // Handle search field
    $('#id_search').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            updateFiltersAndReload();
        }
    }).on('blur', function() {
        if ($(this).val() !== $(this).data('lastValue')) {
            updateFiltersAndReload();
        }
    }).on('focus', function() {
        $(this).data('lastValue', $(this).val());
    });

    // Use server-provided dates for consistency
    var serverDates = {{ js_date_constants|safe }};

    // Handle date range dropdown with server-calculated dates
    $('#id_date_range').on('change', function() {
        var range = $(this).val();
        var fromDate, toDate;

        if (range === '3months') {
            $('#id_date_from').val(serverDates['3months'].from);
            $('#id_date_to').val(serverDates.today);
        } else if (range === '6months') {
            $('#id_date_from').val(serverDates['6months'].from);
            $('#id_date_to').val(serverDates.today);
        } else if (range === '12months') {
            $('#id_date_from').val(serverDates['12months'].from);
            $('#id_date_to').val(serverDates.today);
        } else if (range === 'all') {
            $('#id_date_from').val('');
            $('#id_date_to').val('');
        }
        // For 'custom', don't change the fields - let user set them

        updateFiltersAndReload();
    });

    // Handle date field changes with smart range detection
    $('#id_date_from, #id_date_to').on('change', function() {
        // Detect if the new dates match any predefined range
        var fromVal = $('#id_date_from').val();
        var toVal = $('#id_date_to').val();

        // Check if dates match predefined ranges (exact match)
        if (fromVal === serverDates['3months'].from && toVal === serverDates.today) {
            $('#id_date_range').val('3months');
        } else if (fromVal === serverDates['6months'].from && toVal === serverDates.today) {
            $('#id_date_range').val('6months');
        } else if (fromVal === serverDates['12months'].from && toVal === serverDates.today) {
            $('#id_date_range').val('12months');
        } else if (fromVal === '' && toVal === '') {
            $('#id_date_range').val('all');
        } else if (fromVal || toVal) {
            // Custom dates - always set to custom
            $('#id_date_range').val('custom');
        } else {
            // No dates - default to 12 months
            $('#id_date_range').val('12months');
        }

        updateFiltersAndReload();
    });

    // Visual feedback for filter changes
    $('#filterForm select, #filterForm input[type="checkbox"], #filterForm input[type="date"]').on('change', function() {
        var $this = $(this);
        $this.addClass('border-primary');
        setTimeout(function() {
            $this.removeClass('border-primary');
        }, 1000);
    });
});
</script>
{% endblock %}