{% extends "base.html" %}
{% load static %}

{% block title %}File Browser{% endblock %}

{% block extra_css %}
<!-- File browser styles are now in custom.css -->
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-folder2-open"></i> File Browser</h1>
                <div>
                    <a href="{% url 'application:file_management_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to File Management Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Directory Tabs -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-tabs directory-tabs">
                {% for dir in allowed_dirs %}
                <li class="nav-item">
                    <a class="nav-link {% if dir == directory %}active{% endif %}" 
                       href="?dir={{ dir }}">
                        <i class="bi bi-folder"></i> {{ dir|title }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- File List -->
    <div class="row">
        <div class="col-12">
            <table id="filesTable" class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th style="width: 40px;">Type</th>
                        <th style="width: 35%;">Display Name</th>
                        <th style="width: 80px;">Size</th>
                        <th style="width: 120px;">Modified</th>
                        <th style="width: 80px;">Status</th>
                        <th style="width: 100px;">Enquiry</th>
                        <th style="width: auto;">File Path</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- DataTables will populate this -->
                </tbody>
            </table>

            {% if files_count == 0 %}
            <div class="text-center py-5">
                <i class="bi bi-folder-x display-1 text-muted"></i>
                <h4 class="mt-3">No files found</h4>
                <p class="text-muted">The {{ directory }} directory is empty or doesn't exist.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    // Get files data from template
    const filesData = {{ files_json|safe }};

    // Initialize DataTables with embedded data
    $('#filesTable').DataTable({
        "processing": false,
        "serverSide": false,
        "data": filesData,
        "columns": [
            {
                "data": "extension",
                "orderable": false,
                "width": "40px",
                "className": "text-center",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        let iconClass = 'bi-file text-secondary';
                        if (['.jpg', '.jpeg', '.png', '.gif'].includes(data)) {
                            iconClass = 'bi-image text-primary';
                        } else if (data === '.pdf') {
                            iconClass = 'bi-file-pdf text-danger';
                        } else if (['.doc', '.docx'].includes(data)) {
                            iconClass = 'bi-file-word text-primary';
                        } else if (data === '.mp4') {
                            iconClass = 'bi-camera-video text-info';
                        }
                        return '<i class="bi ' + iconClass + '"></i>';
                    }
                    return data;
                }
            },
            {
                "data": "display_name",
                "width": "35%",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        let html = '<strong>' + data + '</strong>';
                        if (row.extension) {
                            html += ' <small class="text-muted">(' + row.extension.toUpperCase() + ')</small>';
                        }
                        if (data !== row.name && data.length < 50) {
                            html += '<br><small class="text-muted">File: ' + row.name + '</small>';
                        }
                        return html;
                    }
                    return data;
                }
            },
            {
                "data": "size_formatted",
                "type": "num",
                "width": "80px",
                "className": "text-end",
                "render": function(data, type, row) {
                    if (type === 'sort') {
                        return row.size;
                    }
                    return data;
                }
            },
            {
                "data": "modified",
                "width": "120px",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        const date = new Date(data);
                        const now = new Date();
                        const diffTime = Math.abs(now - date);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        let timeAgo;
                        if (diffDays === 1) {
                            timeAgo = '1 day ago';
                        } else if (diffDays < 30) {
                            timeAgo = diffDays + ' days ago';
                        } else if (diffDays < 365) {
                            const months = Math.floor(diffDays / 30);
                            timeAgo = months + ' month' + (months > 1 ? 's' : '') + ' ago';
                        } else {
                            const years = Math.floor(diffDays / 365);
                            timeAgo = years + ' year' + (years > 1 ? 's' : '') + ' ago';
                        }

                        return '<span title="' + date.toLocaleString() + '">' + timeAgo + '</span>';
                    }
                    return data;
                }
            },
            {
                "data": "is_linked",
                "width": "80px",
                "className": "text-center",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        if (data) {
                            return '<span class="badge bg-success"><i class="bi bi-link"></i></span>';
                        } else {
                            return '<span class="badge bg-warning"><i class="bi bi-unlink"></i></span>';
                        }
                    }
                    return data ? 'Linked' : 'Orphaned';
                }
            },
            {
                "data": "enquiry_ref",
                "width": "100px",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        if (data && row.enquiry_id) {
                            const baseUrl = "{% url 'application:enquiry_detail' 999999 %}".replace('999999', row.enquiry_id);
                            return '<a href="' + baseUrl + '" class="text-decoration-none">' + data + '</a>';
                        } else if (data) {
                            return '<span class="text-primary">' + data + '</span>';
                        } else {
                            return '<span class="text-muted">-</span>';
                        }
                    }
                    return data || '';
                }
            },
            {
                "data": "path",
                "width": "auto",
                "render": function(data, type, row) {
                    if (type === 'display') {
                        // Truncate long paths for better display
                        if (data.length > 50) {
                            return '<small class="text-muted font-monospace" title="' + data + '">...' + data.slice(-47) + '</small>';
                        }
                        return '<small class="text-muted font-monospace">' + data + '</small>';
                    }
                    return data;
                }
            }
        ],
        "order": [[3, "desc"]], // Sort by modified date, newest first
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
        "language": {
            "search": "Search files:",
            "lengthMenu": "Show _MENU_ files per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ files",
            "infoEmpty": "No files found",
            "infoFiltered": "(filtered from _MAX_ total files)",
            "zeroRecords": "No files match your search criteria"
        },
        "dom": '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
               '<"row"<"col-sm-12"tr>>' +
               '<"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        "responsive": true,
        "autoWidth": false,
        "scrollX": false,
        "scrollY": false,
        "paging": true,
        "columnDefs": [
            { "targets": [0], "orderable": false, "searchable": false },
            { "targets": [2], "className": "text-end" },
            { "targets": [4], "className": "text-center" }
        ]
    });
});
</script>
{% endblock %}
